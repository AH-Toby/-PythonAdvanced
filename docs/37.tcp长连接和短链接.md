# TCP长连接和短连接

TCP在真正的读写操作之前，server与client之间必须建立一个连接，

当读写操作完成后，双方不再需要这个连接时它们可以释放这个连接，

连接的建立通过三次握手，释放则需要四次握手，

所以说每个连接的建立都是需要资源消耗和时间消耗的。

## 一.TCP通信的整个过程

**建立连接（三次握手）**：

- 客户端发送一个带有SYN（同步）标志位的TCP报文段给服务器，请求建立连接。
- 服务器收到请求后，发送一个带有SYN和ACK（确认）标志位的报文段给客户端，表示同意建立连接。
- 客户端收到服务器的确认后，发送一个带有ACK标志位的报文段给服务器，连接建立成功。

**数据传输**：

- 一旦连接建立，客户端和服务器可以在双方之间传输数据。数据被分割成小的数据段，并通过TCP协议进行传输。
- TCP确保数据的可靠性，包括序号、确认和重传机制，以确保数据包的完整性和正确性。

**关闭连接（四次挥手）**：

- 当一方决定关闭连接时，它发送一个带有FIN（结束）标志位的报文段给另一方，表示要关闭连接。
- 接收方收到FIN后，发送一个ACK标志位的报文段表示已经接受关闭请求，但仍可以发送数据。
- 发送方接收到ACK后，等待发送所有剩余数据，并发送一个带有FIN标志位的报文段给接收方。
- 接收方收到发送方的FIN后，发送一个ACK标志位的报文段，连接关闭完成。

**释放资源**：

- 一旦连接关闭，双方释放已使用的资源，包括套接字和缓冲区。
- 这些资源可以用于建立新的连接或处理其他任务。

![](./img/三次握手、四次挥手.png)

## 二.TCP短连接

TCP短连接是指客户端和服务器在每次数据传输之后都立即关闭连接的通信模式。与TCP长连接不同，短连接不维持持久性连接状态，每次通信都需要建立新的连接，数据传输完成后立即关闭连接。

### 1.TCP短连接的一般过程

**建立连接**：

- 客户端启动并创建一个TCP套接字。
- 客户端使用套接字连接到服务器的目标IP地址和端口号。
- 客户端和服务器之间进行三次握手建立连接。

**数据传输**：

- 客户端和服务器之间传输数据。
- 数据可以分成多个TCP数据包，根据需要传输。

**关闭连接**：

- 数据传输完成后，客户端或服务器中的一方发送一个带有FIN（结束）标志位的TCP报文段，表示要关闭连接。
- 接收方收到FIN后，发送一个带有ACK标志位的报文段表示已经接受关闭请求。
- 发送方接收到ACK后，关闭连接，释放资源。

**释放资源**：

- 客户端和服务器释放已使用的套接字和其他资源，准备建立新的连接或处理其他任务。

### 2.TCP短连接的优点和缺点

**优点：**

**资源效率**：由于连接是短暂的，不需要长时间维护连接状态，因此可以更有效地利用服务器资源。

**灵活性**：每次通信都是独立的连接，不会受到前一次通信的影响，因此更适用于一些不需要保持持久连接的场景。

**隔离性**：每次连接都是独立的，故障或问题不会影响其他连接。

**缺点：**

**连接建立和断开开销**：由于每次通信都需要建立和断开连接，会增加连接管理的开销，包括时间和资源。

**不适合频繁通信的应用**：如果应用程序需要频繁通信，TCP短连接可能会引入较大的开销，不如长连接高效。

## 三.TCP长连接

TCP长连接是一种通信模式，其中客户端和服务器在建立连接后保持连接状态，允许多次数据交换而无需频繁地建立和关闭连接。

### 1.TCP长连接一般过程

**建立连接（三次握手）**：

- 客户端启动并创建一个TCP套接字。

- 客户端使用套接字连接到服务器的目标IP地址和端口号。

- 客户端和服务器之间进行三次握手建立连接：

    a. 客户端发送一个带有SYN（同步）标志位的TCP报文段给服务器，请求建立连接。

    b. 服务器收到请求后，发送一个带有SYN和ACK（确认）标志位的报文段给客户端，表示同意建立连接。

    c. 客户端收到服务器的确认后，发送一个带有ACK标志位的报文段给服务器，连接建立成功。

**数据传输**：

- 一旦连接建立，客户端和服务器可以在双方之间传输数据。
- 数据可以分成多个TCP数据包，根据需要传输。
- 数据传输可以持续一段时间，客户端和服务器之间可以进行多轮数据交换。

**保持连接状态**：

- 在长连接中，客户端和服务器保持连接状态，不立即关闭连接，以便在需要时可以随时传输数据。
- 这使得客户端和服务器可以随时进行双向通信。

**关闭连接（四次挥手）**（可选）：

- 如果需要关闭连接，客户端或服务器可以发起关闭过程。
- 关闭连接的过程与TCP短连接的四次挥手类似，包括发送FIN和ACK报文段，等待确认，并最终关闭连接。

**释放资源**：

- 当连接不再需要时，客户端和服务器释放已使用的套接字和其他资源。
- 这些资源可以用于建立新的连接或处理其他任务。

> 注意：
>
> TCP长连接通常用于需要保持持久通信的应用程序，如实时通信、在线游戏、社交媒体和实时监控等。在长连接模式下，服务器和客户端可以在连接建立后保持连接状态，以便可以随时进行数据传输。这减少了连接建立和断开的开销，提高了通信的效率。但同时也需要确保连接不会无限期保持，以避免资源浪费，因此通常会设置连接的最大生存时间或使用心跳机制来维护连接的健康状态。

### 2.TCP长连接的特点和优点

**优点**：

**减少连接开销**：TCP长连接允许客户端和服务器在连接建立后保持连接状态，不需要频繁地建立和断开连接。这降低了连接建立和断开的开销，提高了性能。

**高效的数据传输**：由于连接保持开放，可以在多次通信之间重用已建立的连接，减少了额外的TCP握手和挥手操作，提高了数据传输的效率。

**实时通信**：长连接适用于需要实时通信的应用程序，如即时通讯、在线游戏和实时监控。通过保持连接状态，可以实时地交换数据，实现快速响应和即时通知。

**节省带宽**：长连接可以更有效地使用带宽，因为不需要频繁地进行连接建立和断开操作，减少了额外的网络流量。

**隔离性**：每个长连接都是独立的，连接之间互不干扰，因此故障或问题不会影响其他连接。这提高了系统的稳定性和可靠性。

**缺点**：

**资源占用**：长连接需要服务器维护连接状态，包括内存和CPU资源。如果同时存在大量长连接，服务器资源可能会受到限制，导致性能下降。

**连接管理复杂性**：长连接需要谨慎管理，以确保不会无限期保持连接。过多的长连接可能导致资源耗尽，需要定期进行连接清理。

**不适用于所有情况**：长连接适用于需要保持持久通信的应用程序，但不适用于所有情况。对于一些临时性的操作，如HTTP请求，短连接可能更合适。

**可扩展性问题**：如果应用程序需要处理大量并发连接，长连接可能会对服务器的可扩展性产生挑战，需要采用适当的负载均衡和连接池管理。

## 四. TCP长/短连接操作过程

### 4.1.短连接的操作步骤

建立连接——数据传输——关闭连接...建立连接——数据传输——关闭连接

![img](./img/短连接.png)

### 4.2.长连接的操作步骤

建立连接——数据传输...（保持连接）...数据传输——关闭连接

![img](./img/长连接.png)

## 五. TCP长/短连接的应用场景

- 长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况。

    每个TCP连接都需要三次握手，这需要时间，如果每个操作都是先连接，

    再操作的话那么处理速度 会降低很多，所以每个操作完后都不断开，

    再次处理时直接发送数据包就OK了，不用建立TCP连接。

    例如：数据库的连接用长连接，如果用短连接频繁的通信会造成socket错误，

    而且频繁的socket 创建也是对资源的浪费。

- 而像WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，

    而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，

    如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，

    那可想而知吧。所以并发量大，但每个用户无需频繁操作情况下需用短连好。